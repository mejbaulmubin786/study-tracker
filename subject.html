<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activity Tracker</title>
  <style>
    /* --------- Base / Reset --------- */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --accent-2:#60a5fa;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Noto Sans Bengali', sans-serif;background:linear-gradient(180deg,#061021 0%, #071730 60%);color:#e6eef6}
    a{color:var(--accent-2)}
    /* --------- Layout --------- */
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#032; font-weight:700}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    /* --------- Controls --------- */
    .controls{display:flex;gap:12px;align-items:center;margin-top:18px;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    input,select,button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;color:inherit}
    .btn{cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#062;box-shadow:0 6px 20px rgba(96,165,250,0.08);border:none}
    /* --------- Grid & Cards --------- */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:14px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
    /* Left list */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .item .meta{flex:1}
    .item .title{font-weight:600;margin-bottom:6px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted)}
    .status{font-size:12px;padding:6px 8px;border-radius:8px}
    .status.running{background:#10263a;color:#8bd3ff}
    .status.closed{background:#0b2b1a;color:#8fffd4}
    .status.revision-running{background:#1e3a8a;color:#93c5fd}
    .status.revision-done{background:#166534;color:#86efac}
    .open-btn{margin-top:8px}
    /* Right details */
    .details h3{margin:0 0 6px 0}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .field{font-size:13px;color:var(--muted)}
    .notes{margin-top:12px;color:var(--muted);white-space:pre-wrap}
    /* Footer small */
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal{width:100%;max-width:720px;background:linear-gradient(180deg,#061426,#071b2a);border-radius:12px;padding:16px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    textarea{min-height:110px;padding:10px;border-radius:8px}
    .has-sections{margin-top:10px}
    .section-fields{display:none;gap:5px;flex-direction:column}
    /* Responsive */
    @media(max-width:920px){.grid{grid-template-columns:1fr;}.brand h1{font-size:18px}}
    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" id="logo">AT</div>
        <div>
          <h1 id="pageTitle">Activity Tracker</h1>
          <p class="lead" id="pageDesc">আপনার course, repo, notes, এবং review-tracker এক জায়গায় — দ্রুত খোঁজা, যোগ/সম্পাদনা ও সংরক্ষণ।</p>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" id="addBtn">নতুন এন্ট্রি যোগ করুন</button>
      </div>
    </header>
    <div class="controls">
      <input type="search" id="q" placeholder="Search by title, source, repo or notes..." class="search" />
      <select id="filterType">
        <option value="all">সব ধরণ</option>
        <option value="course">Course</option>
        <option value="book">Book</option>
        <option value="youtube">YouTube</option>
        <option value="project">Project / Repo</option>
        <option value="note">Notes</option>
        <option value="review">Review</option>
      </select>
      <select id="filterStatus">
        <option value="all">সব অবস্থা</option>
        <option value="running">চলমান</option>
        <option value="closed">সম্পন্ন</option>
        <option value="revision-running">রিভিশন চলমান</option>
        <option value="revision-done">রিভিশন সম্পন্ন</option>
      </select>
      <select id="sortBy">
        <option value="updated">সর্বশেষ আপডেট</option>
        <option value="start">শুরু তারিখ</option>
        <option value="doneDate">সমাপ্তির তারিখ</option>
      </select>
    </div>
    <div class="grid">
      <div class="panel">
        <div class="list" id="list"></div>
        <footer>কোনো এন্ট্রির উপর ক্লিক করে ডান দিকের প্যানেলে বিস্তারিত দেখুন। যদি সেকশন থাকে তাহলে Open বাটনে ক্লিক করুন।</footer>
      </div>
      <aside class="panel details" id="details">
        <h3>নির্বাচিত এন্ট্রি নেই</h3>
        <p class="muted">কোনো আইটেম নির্বাচন করুন তখন বিস্তারিত এখানে দেখাবে।</p>
      </aside>
    </div>
    <!-- Modal: Add / Edit -->
    <div class="modal-backdrop" id="modal">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong id="modalTitle">নতুন এন্ট্রি</strong>
          <button id="closeModal">✕</button>
        </div>
        <form id="entryForm">
          <div class="form-grid">
            <div>
              <label>Title</label>
              <input name="title" required placeholder="কোর্স/প্রোজেক্ট/নোট নাম" />
            </div>
            <div>
              <label>Type</label>
              <select name="type">
                <option value="course">Course</option>
                <option value="book">Book</option>
                <option value="youtube">YouTube</option>
                <option value="project">Project</option>
                <option value="note">Note</option>
                <option value="review">Review</option>
              </select>
            </div>
            <div>
              <label>Source (Udemy / YouTube / GitHub / Local)</label>
              <input name="source" placeholder="Udemy, YouTube channel, GitHub repo..." />
            </div>
            <div>
              <label>Link (optional)</label>
              <input name="link" placeholder="https://..." />
            </div>
            <div>
              <label>Start Date</label>
              <input type="date" name="startDate" />
            </div>
            <div>
              <label>Completed Date</label>
              <input type="date" name="doneDate" />
            </div>
          </div>
          <div class="has-sections">
            <label><input type="checkbox" name="hasSections" /> Has Sections/Topics?</label>
            <div class="section-fields">
              <label>Number of Sections:</label>
              <input type="number" id="numSections" min="1" max="20" value="1" />
              <div id="sectionNameFields"></div>
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Notes / Short description</label>
            <textarea name="notes" placeholder="কিছু মূল বর্ণনা, কোথায় নোট রাখা আছে (Google Drive / Notion / local path) ইত্যাদি"></textarea>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button type="button" id="deleteBtn" style="display:none">Delete</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // ------------------ Setup ------------------
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('subject');
    if(!subjectId){
      document.body.innerHTML = '<h1 style="text-align:center;color:var(--muted);">Invalid subject ID. Go back to index.html</h1>';
    }
    const STORAGE_KEY = 'study-tracker';
    function genId(){return 'id-'+Math.random().toString(36).slice(2,9)}
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{ return JSON.parse(raw) }catch(e){ return null }
    }
    function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    const allData = load();
    const subject = allData ? allData.find(s => s.id === subjectId) : null;
    if(!subject){
      document.body.innerHTML = '<h1 style="text-align:center;color:var(--muted);">Subject not found.</h1>';
    }
    document.getElementById('logo').textContent = subject.title.charAt(0);
    document.getElementById('pageTitle').textContent = `Activity Tracker — ${subject.title}`;
    document.getElementById('pageDesc').textContent = subject.desc;
    let data = subject.entries || [];
    let selectedId = null;
    // ------------------ UI refs ------------------
    const listEl = document.getElementById('list');
    const detailsEl = document.getElementById('details');
    const qEl = document.getElementById('q');
    const filterTypeEl = document.getElementById('filterType');
    const filterStatusEl = document.getElementById('filterStatus');
    const sortByEl = document.getElementById('sortBy');
    // modal
    const modal = document.getElementById('modal');
    const addBtn = document.getElementById('addBtn');
    const closeModal = document.getElementById('closeModal');
    const entryForm = document.getElementById('entryForm');
    const modalTitle = document.getElementById('modalTitle');
    const deleteBtn = document.getElementById('deleteBtn');
    const hasSectionsCb = entryForm.querySelector('[name="hasSections"]');
    const numSectionsInput = document.getElementById('numSections');
    const sectionNameFields = document.getElementById('sectionNameFields');
    // ------------------ Section fields handler ------------------
    function updateSectionFields(){
      const has = hasSectionsCb.checked;
      const num = parseInt(numSectionsInput.value) || 1;
      sectionNameFields.innerHTML = '';
      if(!has) return;
      for(let i=1; i<=num; i++){
        const div = document.createElement('div');
        div.innerHTML = `<label>Section ${i} Name:</label><input name="section${i}" placeholder="Section ${i} title" />`;
        sectionNameFields.appendChild(div);
      }
    }
    hasSectionsCb.addEventListener('change', updateSectionFields);
    numSectionsInput.addEventListener('input', updateSectionFields);
    // ------------------ render list ------------------
    function renderList(){
      const q = qEl.value.trim().toLowerCase();
      const typeF = filterTypeEl.value;
      const statusF = filterStatusEl.value;
      const sortBy = sortByEl.value;
      let items = [...data];
      if(typeF!=='all') items = items.filter(i=>i.type===typeF);
      if(statusF!=='all') items = items.filter(i=>i.status===statusF);
      if(q) items = items.filter(i=> (i.title||'').toLowerCase().includes(q) || (i.source||'').toLowerCase().includes(q) || (i.notes||'').toLowerCase().includes(q) );
      if(sortBy==='updated') items.sort((a,b)=> (b.updated||0)-(a.updated||0));
      if(sortBy==='start') items.sort((a,b)=> new Date(b.startDate||0)-new Date(a.startDate||0));
      if(sortBy==='doneDate') items.sort((a,b)=> new Date(b.doneDate||0)-new Date(a.doneDate||0));
      listEl.innerHTML = items.map(i=>{
        const statusClass = i.status === 'closed' ? 'closed' : i.status === 'revision-running' ? 'revision-running' : i.status === 'revision-done' ? 'revision-done' : 'running';
        const label = getStatusLabel(i.status);
        return `
          <div class="item" data-id="${i.id}">
            <div class="meta">
              <div class="title">${escapeHtml(i.title)}</div>
              <div class="tags">
                <div class="tag">${escapeHtml(i.type)}</div>
                <div class="tag">${escapeHtml(i.source||'—')}</div>
                <div class="tag">Start: ${i.startDate||'—'}</div>
                <div class="tag">Done: ${i.doneDate||'—'}</div>
              </div>
            </div>
            <div style="text-align:right;min-width:86px">
              <div class="status ${statusClass}">${label}</div>
              ${i.sections ? `<button class="btn open-btn primary" data-id="${i.id}">Open Sections</button>` : ''}
              <div style="margin-top:8px;font-size:12px;color:var(--muted)">${timeAgo(i.updated)}</div>
            </div>
          </div>
        `;
      }).join('');
      // attach click
      document.querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click',(e)=>{
          if(e.target.classList.contains('open-btn')) return;
          const id = el.getAttribute('data-id');
          selectedId = id;
          showOverview(id);
        });
      });
      document.querySelectorAll('.open-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-id');
          const entry = data.find(d=>d.id===id);
          if(entry.sections){
            window.open(`sections.html?subject=${subjectId}&entry=${id}`,'_blank');
          }
        });
      });
      if(items.length===0) listEl.innerHTML = '<div class="muted">কোনো এন্ট্রি পাওয়া যায়নি — নতুন যোগ করুন।</div>';
    }
    function getStatusLabel(s){
      const labels={running:'চলমান', closed:'সম্পন্ন', 'revision-running':'রিভিশন চলমান', 'revision-done':'রিভিশন সম্পন্ন'};
      return labels[s] || s.toUpperCase();
    }
    // ------------------ overview ------------------
    function showOverview(id){
      const it = data.find(d=>d.id===id);
      if(!it) return;
      const statusClass = it.status === 'closed' ? 'closed' : it.status === 'revision-running' ? 'revision-running' : it.status === 'revision-done' ? 'revision-done' : 'running';
      const label = getStatusLabel(it.status);
      let sectionsInfo = '';
      if(it.sections && it.sections.length > 0){
        const completeSecs = it.sections.filter(s => s.status === 'closed' || s.status === 'revision-done').length;
        const totalSecs = it.sections.length;
        const secStatus = totalSecs === completeSecs ? 'closed' : 'running';
        sectionsInfo = `<p><strong>Sections:</strong> ${completeSecs}/${totalSecs} complete. Overall: <span class="status ${secStatus}">${getStatusLabel(secStatus)}</span></p>`;
      }
      detailsEl.innerHTML = `
        <h3>${escapeHtml(it.title)}</h3>
        <div class="fields">
          <div class="field"><strong>Type</strong><div class="muted">${escapeHtml(it.type)}</div></div>
          <div class="field"><strong>Source</strong><div class="muted">${escapeHtml(it.source||'—')}</div></div>
          <div class="field"><strong>Start</strong><div class="muted">${it.startDate||'—'}</div></div>
          <div class="field"><strong>Completed</strong><div class="muted">${it.doneDate||'—'}</div></div>
        </div>
        ${sectionsInfo}
        <div style="margin-top:10px" class="notes"><strong>Notes / Stored at:</strong>\n${escapeHtml(it.notes||'—')}</div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          ${it.link?`<a href="${it.link}" target="_blank" class="btn">Open Link</a>`:''}
          <button class="btn" id="editBtn">Edit</button>
          <button class="btn" id="markBtn">${label === 'সম্পন্ন' || label === 'রিভিশন সম্পন্ন' ? 'Mark Running' : 'Mark Closed'}</button>
        </div>
      `;
      document.getElementById('editBtn').addEventListener('click',()=>openModalFor(it.id));
      document.getElementById('markBtn').addEventListener('click',()=>{
        const currentStatus = it.status;
        if(currentStatus === 'closed' || currentStatus === 'revision-done'){
          it.status = 'running';
        } else {
          it.status = 'closed';
        }
        it.updated = Date.now();
        save(allData);
        data = subject.entries; // refresh
        renderList();
        showOverview(it.id);
      });
    }
    // ------------------ modal operations ------------------
    function openModalFor(id){
      modal.style.display='flex';
      updateSectionFields(); // initial
      if(id){
        modalTitle.textContent='এন্ট্রি সম্পাদনা করুন';
        deleteBtn.style.display='inline-block';
        const it = data.find(d=>d.id===id);
        entryForm.title.value = it.title;
        entryForm.type.value = it.type;
        entryForm.source.value = it.source || '';
        entryForm.link.value = it.link || '';
        entryForm.startDate.value = it.startDate || '';
        entryForm.doneDate.value = it.doneDate || '';
        entryForm.notes.value = it.notes || '';
        hasSectionsCb.checked = !!it.sections;
        if(it.sections){
          numSectionsInput.value = it.sections.length;
          updateSectionFields();
          it.sections.forEach((sec, idx) => {
            entryForm.querySelector(`[name="section${idx+1}"]`).value = sec.title;
          });
        }
        deleteBtn.onclick = ()=>{ 
          if(confirm('মুছে ফেলতে চান?')){
            data = data.filter(x=>x.id!==id);
            subject.entries = data;
            save(allData);
            selectedId=null;
            renderList();
            detailsEl.innerHTML='<h3>নির্বাচিত এন্ট্রি নেই</h3><p class="muted">কোনো আইটেম নির্বাচন করুন তখন বিস্তারিত এখানে দেখাবে।</p>';
            closeModalAction();
          }
        };
        entryForm.onsubmit = (e)=>{
          e.preventDefault();
          it.title = entryForm.title.value;
          it.type = entryForm.type.value;
          it.source = entryForm.source.value;
          it.link = entryForm.link.value;
          it.startDate = entryForm.startDate.value;
          it.doneDate = entryForm.doneDate.value;
          it.notes = entryForm.notes.value;
          it.updated = Date.now();
          if(hasSectionsCb.checked){
            const num = parseInt(numSectionsInput.value) || 1;
            it.sections = [];
            for(let i=1; i<=num; i++){
              const name = entryForm.querySelector(`[name="section${i}"]`)?.value || `Section ${i}`;
              if(name.trim()) it.sections.push({id: genId(), title: name, status: 'running', topics: []});
            }
          } else {
            delete it.sections;
          }
          subject.entries = data;
          save(allData);
          renderList();
          showOverview(it.id);
          closeModalAction();
        };
      } else {
        modalTitle.textContent='নতুন এন্ট্রি যোগ করুন';
        deleteBtn.style.display='none';
        entryForm.reset();
        hasSectionsCb.checked = false;
        updateSectionFields();
        entryForm.onsubmit = (e)=>{
          e.preventDefault();
          const newItem = {
            id: genId(),
            title: entryForm.title.value,
            type: entryForm.type.value,
            source: entryForm.source.value,
            link: entryForm.link.value,
            startDate: entryForm.startDate.value,
            doneDate: entryForm.doneDate.value,
            notes: entryForm.notes.value,
            status: entryForm.doneDate ? 'closed' : 'running',
            updated: Date.now()
          };
          if(hasSectionsCb.checked){
            const num = parseInt(numSectionsInput.value) || 1;
            newItem.sections = [];
            for(let i=1; i<=num; i++){
              const name = entryForm.querySelector(`[name="section${i}"]`)?.value || `Section ${i}`;
              if(name.trim()) newItem.sections.push({id: genId(), title: name, status: 'running', topics: []});
            }
          }
          data.unshift(newItem);
          subject.entries = data;
          save(allData);
          renderList();
          selectedId=newItem.id;
          showOverview(newItem.id);
          closeModalAction();
        };
      }
    }
    function closeModalAction(){ modal.style.display='none'; }
    // ------------------ events ------------------
    addBtn.addEventListener('click', ()=>openModalFor());
    closeModal.addEventListener('click', closeModalAction);
    qEl.addEventListener('input', renderList);
    filterTypeEl.addEventListener('change', renderList);
    filterStatusEl.addEventListener('change', renderList);
    sortByEl.addEventListener('change', renderList);
    // ------------------ util ------------------
    function timeAgo(ts){
      if(!ts) return '—';
      const s = Math.floor((Date.now()-ts)/1000);
      if(s<60) return s+'s ago';
      if(s<3600) return Math.floor(s/60)+'m ago';
      if(s<86400) return Math.floor(s/3600)+'h ago';
      return Math.floor(s/86400)+'d ago';
    }
    function escapeHtml(str){
      if(!str) return '';
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    // initial render
    renderList();
  </script>
</body>
</html>